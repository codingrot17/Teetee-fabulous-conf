<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Appwrite Storage</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .info { background: #dbeafe; color: #1d4ed8; }
        button {
            background: linear-gradient(135deg, #8B4A87, #D4A574);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .code {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Appwrite Storage Setup</h1>
        <p>This tool will create the storage bucket needed for image uploads in your cake business dashboard.</p>
        
        <div id="status"></div>
        
        <button onclick="checkStorage()" id="checkBtn">Check Current Storage</button>
        <button onclick="setupStorage()" id="setupBtn">Setup Storage Bucket</button>
        <button onclick="testUpload()" id="testBtn">Test Upload</button>
        
        <div id="results"></div>
        
        <!-- Test upload input -->
        <div style="margin-top: 20px;">
            <h3>Test Image Upload:</h3>
            <input type="file" id="testFile" accept="image/*" />
        </div>
    </div>

    <script type="module">
        import { Client, Storage, Permission, Role, ID } from 'https://cdn.skypack.dev/appwrite@13.0.0';

        // Your Appwrite configuration
        const APPWRITE_CONFIG = {
            endpoint: 'https://cloud.appwrite.io/v1',
            projectId: '68ca0f1c00035ab92fa8',
            bucketId: '68cdb9ef003cf2887d53'
        };

        const client = new Client()
            .setEndpoint(APPWRITE_CONFIG.endpoint)
            .setProject(APPWRITE_CONFIG.projectId);

        const storage = new Storage(client);

        window.checkStorage = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<div class="info">Checking storage configuration...</div>';
            
            try {
                // Try to get the bucket
                const bucket = await storage.getBucket(APPWRITE_CONFIG.bucketId);
                
                let results = '<h3>Storage Bucket Details:</h3>';
                results += `<div class="code">
                    <strong>Bucket ID:</strong> ${bucket.$id}<br>
                    <strong>Name:</strong> ${bucket.name}<br>
                    <strong>Max File Size:</strong> ${bucket.fileSecurity ? (bucket.maximumFileSize / (1024*1024)).toFixed(1) + 'MB' : 'Unlimited'}<br>
                    <strong>File Security:</strong> ${bucket.fileSecurity ? 'Enabled' : 'Disabled'}<br>
                    <strong>Enabled:</strong> ${bucket.enabled ? 'Yes' : 'No'}<br>
                    <strong>Allowed Extensions:</strong> ${bucket.allowedFileExtensions.length > 0 ? bucket.allowedFileExtensions.join(', ') : 'All'}
                </div>`;
                
                // Check permissions
                results += '<h4>Permissions:</h4>';
                results += '<div class="code">';
                if (bucket.$permissions && bucket.$permissions.length > 0) {
                    bucket.$permissions.forEach(perm => {
                        results += `${perm}<br>`;
                    });
                } else {
                    results += 'No specific permissions set';
                }
                results += '</div>';
                
                // Try to list files
                try {
                    const files = await storage.listFiles(APPWRITE_CONFIG.bucketId);
                    results += `<h4>Files in bucket: ${files.total}</h4>`;
                    if (files.total > 0) {
                        results += '<ul>';
                        files.files.slice(0, 5).forEach(file => {
                            results += `<li>${file.name} (${(file.sizeOriginal / 1024).toFixed(1)}KB)</li>`;
                        });
                        if (files.total > 5) {
                            results += `<li>... and ${files.total - 5} more</li>`;
                        }
                        results += '</ul>';
                    }
                } catch (listError) {
                    results += `<div class="error">Cannot list files: ${listError.message}</div>`;
                }
                
                resultsDiv.innerHTML = results;
                statusDiv.innerHTML = '<div class="success">Storage check completed!</div>';
                
            } catch (error) {
                if (error.code === 404) {
                    statusDiv.innerHTML = '<div class="error">Storage bucket not found! You need to create it.</div>';
                    resultsDiv.innerHTML = '<p>The storage bucket "cake-images" does not exist. Click "Setup Storage Bucket" to create it.</p>';
                } else {
                    statusDiv.innerHTML = `<div class="error">Error checking storage: ${error.message}</div>`;
                    resultsDiv.innerHTML = `<div class="error">Error details: ${error.message}</div>`;
                }
                console.error('Storage check error:', error);
            }
        };

        window.setupStorage = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const setupBtn = document.getElementById('setupBtn');
            
            setupBtn.disabled = true;
            statusDiv.innerHTML = '<div class="info">Creating storage bucket...</div>';
            
            try {
                // Create storage bucket with proper permissions
                const bucket = await storage.createBucket(
                    APPWRITE_CONFIG.bucketId,
                    'Cake Images',
                    [
                        Permission.read(Role.any()),
                        Permission.create(Role.users()),
                        Permission.update(Role.users()),
                        Permission.delete(Role.users())
                    ],
                    true,  // fileSecurity
                    true,  // enabled
                    10485760,  // maxFileSize (10MB)
                    ['jpg', 'jpeg', 'png', 'gif', 'webp'],  // allowedFileExtensions
                    'none',  // compression
                    false,  // encryption
                    false   // antivirus
                );
                
                let results = '<h3>Storage Bucket Created Successfully!</h3>';
                results += `<div class="success">‚úÖ Bucket "${bucket.name}" created with ID: ${bucket.$id}</div>`;
                results += '<div class="code">';
                results += `<strong>Configuration:</strong><br>`;
                results += `- Max File Size: ${(bucket.maximumFileSize / (1024*1024)).toFixed(1)}MB<br>`;
                results += `- Allowed Extensions: ${bucket.allowedFileExtensions.join(', ')}<br>`;
                results += `- File Security: ${bucket.fileSecurity ? 'Enabled' : 'Disabled'}<br>`;
                results += `- Permissions: Set for authenticated users`;
                results += '</div>';
                
                resultsDiv.innerHTML = results;
                statusDiv.innerHTML = '<div class="success">Storage setup completed! You can now upload images.</div>';
                
            } catch (error) {
                if (error.code === 409) {
                    statusDiv.innerHTML = '<div class="info">Storage bucket already exists. Checking permissions...</div>';
                    // Try to update permissions if bucket exists
                    try {
                        await storage.updateBucket(
                            APPWRITE_CONFIG.bucketId,
                            'Cake Images',
                            [
                                Permission.read(Role.any()),
                                Permission.create(Role.users()),
                                Permission.update(Role.users()),
                                Permission.delete(Role.users())
                            ]
                        );
                        resultsDiv.innerHTML = '<div class="success">‚úÖ Updated existing bucket permissions</div>';
                        statusDiv.innerHTML = '<div class="success">Storage permissions updated!</div>';
                    } catch (updateError) {
                        statusDiv.innerHTML = `<div class="error">Could not update bucket permissions: ${updateError.message}</div>`;
                    }
                } else {
                    statusDiv.innerHTML = `<div class="error">Failed to create storage bucket: ${error.message}</div>`;
                    resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                }
                console.error('Storage setup error:', error);
            }
            
            setupBtn.disabled = false;
        };

        window.testUpload = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const fileInput = document.getElementById('testFile');
            
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="error">Please select a file first</div>';
                return;
            }
            
            const file = fileInput.files[0];
            statusDiv.innerHTML = '<div class="info">Testing file upload...</div>';
            
            try {
                // Upload test file
                const uploadResult = await storage.createFile(
                    APPWRITE_CONFIG.bucketId,
                    ID.unique(),
                    file
                );
                
                // Get file URL
                const fileUrl = `${APPWRITE_CONFIG.endpoint}/storage/buckets/${APPWRITE_CONFIG.bucketId}/files/${uploadResult.$id}/view?project=${APPWRITE_CONFIG.projectId}`;
                
                let results = '<h3>Upload Test Results:</h3>';
                results += `<div class="success">‚úÖ File uploaded successfully!</div>`;
                results += `<div class="code">
                    <strong>File ID:</strong> ${uploadResult.$id}<br>
                    <strong>Size:</strong> ${(uploadResult.sizeOriginal / 1024).toFixed(1)}KB<br>
                    <strong>Type:</strong> ${uploadResult.mimeType}
                </div>`;
                results += `<div style="margin-top: 15px;">
                    <strong>Preview:</strong><br>
                    <img src="${fileUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #e5e7eb;" alt="Uploaded image">
                </div>`;
                
                resultsDiv.innerHTML = results;
                statusDiv.innerHTML = '<div class="success">Upload test successful! Your image uploads should work now.</div>';
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Upload test failed: ${error.message}</div>`;
                resultsDiv.innerHTML = `<div class="error">Error details: ${error.message}<br>Make sure you've set up the storage bucket first.</div>`;
                console.error('Upload test error:', error);
            }
        };
    </script>
</body>
</html>